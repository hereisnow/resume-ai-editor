<script>
  // --- Stepper ---
  function setStep(step) {
    var circles = document.querySelectorAll(".step-circle");
    circles.forEach(function (circle, index) {
      var s = index + 1;
      circle.classList.remove(
        "bg-indigo-500",
        "border-indigo-500",
        "text-white",
        "bg-slate-900",
        "border-slate-900",
        "bg-white",
        "border-slate-300",
        "text-slate-500"
      );
      if (s < step) {
        circle.classList.add("bg-slate-900", "border-slate-900", "text-white");
      } else if (s === step) {
        circle.classList.add("bg-indigo-500", "border-indigo-500", "text-white");
      } else {
        circle.classList.add("bg-white", "border-slate-300", "text-slate-500");
      }
    });
  }

  // --- Mode switching ---
  var modeButtons = document.querySelectorAll("[data-mode]");
  var modePicker = document.getElementById("mode-picker");
  var generatePanel = document.getElementById("generate-panel");
  var analyzePanel = document.getElementById("analyze-panel");

  modeButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      var mode = btn.getAttribute("data-mode");
      if (mode === "generate") {
        generatePanel.classList.remove("hidden");
        analyzePanel.classList.add("hidden");
      } else {
        analyzePanel.classList.remove("hidden");
        generatePanel.classList.add("hidden");
      }
      modePicker.classList.add("opacity-60", "pointer-events-none");
      setStep(2);
      var panel = mode === "generate" ? generatePanel : analyzePanel;
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  });

  // --- Skills input for Generate ---
  var skillsWrapper = document.getElementById("g-skills-wrapper");
  var skillsInput = document.getElementById("g-skills-input");

  skillsWrapper.addEventListener("click", function () {
    skillsInput.focus();
  });

  skillsWrapper.addEventListener("click", function (e) {
    if (e.target.classList.contains("skill-remove")) {
      e.target.closest(".skill-tag").remove();
    }
  });

  skillsInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      var value = skillsInput.value.trim();
      if (!value) return;
      var tag = document.createElement("span");
      tag.className =
        "skill-tag inline-flex items-center gap-1 rounded-full bg-slate-200/80 px-2 py-0.5 text-[11px] text-slate-700";
      tag.innerHTML =
        "<span>" +
        value +
        "</span><button type='button' class='skill-remove ml-1 text-[11px] text-slate-500 hover:text-slate-800'>×</button>";
      skillsWrapper.insertBefore(tag, skillsInput);
      skillsInput.value = "";
    }
    if (e.key === "Backspace" && !skillsInput.value) {
      var tags = skillsWrapper.querySelectorAll(".skill-tag");
      if (tags.length > 0) {
        tags[tags.length - 1].remove();
      }
    }
  });

  // --- Generate form ---
  var gForm = document.getElementById("generate-form");
  var gPreview = document.getElementById("g-preview");
  var gPreviewEmpty = document.getElementById("g-preview-empty");
  var gClear = document.getElementById("g-clear");

  gForm.addEventListener("submit", function (e) {
    e.preventDefault();

    var name = document.getElementById("g-fullname").value.trim() || "Your Name";
    var contact = document.getElementById("g-contact").value.trim();
    var role = document.getElementById("g-role").value.trim() || "Target Role";
    var level = document.getElementById("g-level").value;
    var summary = document.getElementById("g-summary").value.trim();
    var exp = document.getElementById("g-experience").value.trim();
    var edu = document.getElementById("g-education").value.trim();

    var skillLabels = [];
    skillsWrapper
      .querySelectorAll(".skill-tag span:first-child")
      .forEach(function (el) {
        skillLabels.push(el.textContent.trim());
      });

    var html = "";
    html += "<h1 class='text-sm font-semibold'>" + name + "</h1>";
    html += "<p class='text-[10px] text-slate-500 mb-2'>";
    if (contact) html += contact + " · ";
    html += level + " " + role + "</p>";

    if (summary) {
      html +=
        "<h2 class='mt-2 text-[10px] font-semibold tracking-wide text-slate-600 uppercase'>Summary</h2>";
      html += "<p class='text-[10px]'>" + summary + "</p>";
    }

    if (skillLabels.length) {
      html +=
        "<h2 class='mt-2 text-[10px] font-semibold tracking-wide text-slate-600 uppercase'>Skills</h2>";
      html += "<ul class='list-disc pl-4 text-[10px] space-y-0.5'>";
      skillLabels.forEach(function (s) {
        html += "<li>" + s + "</li>";
      });
      html += "</ul>";
    }

    if (exp) {
      html +=
        "<h2 class='mt-2 text-[10px] font-semibold tracking-wide text-slate-600 uppercase'>Experience</h2>";
      html += "<p class='whitespace-pre-line text-[10px]'>" + exp + "</p>";
    }

    if (edu) {
      html +=
        "<h2 class='mt-2 text-[10px] font-semibold tracking-wide text-slate-600 uppercase'>Education</h2>";
      html += "<p class='text-[10px]'>" + edu + "</p>";
    }

    gPreview.innerHTML = html;
    gPreviewEmpty.classList.add("hidden");
    gPreview.classList.remove("hidden");
    setStep(3);
  });

  gClear.addEventListener("click", function () {
    gForm.reset();
    skillsWrapper.querySelectorAll(".skill-tag").forEach(function (tag) {
      tag.remove();
    });
    gPreview.innerHTML = "";
    gPreview.classList.add("hidden");
    gPreviewEmpty.classList.remove("hidden");
    setStep(2);
  });

  // --- Analyze: file upload feedback ---
  var aFileInput = document.getElementById("a-file");
  var aTextArea = document.getElementById("a-text");

  aFileInput.addEventListener("change", function (e) {
    var file = e.target.files[0];
    var label = document.querySelector("label[for='a-file']");
    if (!file) {
      return;
    }

    var info = label.querySelector(".file-info");
    if (!info) {
      info = document.createElement("p");
      info.className =
        "file-info mt-2 text-[11px] text-slate-500 border-t border-dashed border-slate-200 pt-2 w-full text-center";
      label.appendChild(info);
    }
    info.textContent = "Selected file: " + file.name + " (" + Math.round(file.size / 1024) + " KB)";

    // If it's a plain text file, auto-fill textarea so analysis uses real content.
    if (file.type === "text/plain") {
      info.textContent += " – loading content…";
      var reader = new FileReader();
      reader.onload = function (ev) {
        aTextArea.value = ev.target.result;
        info.textContent =
          "Selected file: " + file.name + " (" + Math.round(file.size / 1024) + " KB, loaded into text area)";
      };
      reader.readAsText(file);
    }
  });

  // --- Analyze form with simple heuristic "AI" ---
  var aForm = document.getElementById("analyze-form");
  var aPreview = document.getElementById("a-preview");
  var aPreviewEmpty = document.getElementById("a-preview-empty");
  var aClear = document.getElementById("a-clear");

  function buildAnalysis(text, role) {
    var cleanText = text.trim();
    var wordCount = cleanText ? cleanText.split(/\s+/).length : 0;
    var sentences = cleanText.match(/[.!?]/g) || [];
    var sentenceCount = sentences.length || 1;
    var avgSentence = Math.round(wordCount / sentenceCount);

    var bulletMatches = cleanText.match(/(^|\n)\s*[-*•]/g) || [];
    var bulletCount = bulletMatches.length;

    var metricMatches =
      cleanText.match(/\d+%|\$\d+|\d+\s+(years?|months?|weeks?|days?)/gi) || [];
    var metricCount = metricMatches.length;

    var strengths = [];
    var issues = [];
    var steps = [];

    if (wordCount > 0 && wordCount <= 500) {
      strengths.push("Overall length is reasonable (" + wordCount + " words).");
    } else if (wordCount > 500) {
      issues.push("Resume may be too long (" + wordCount + " words). Try to keep it close to one page.");
    }

    if (bulletCount >= 3) {
      strengths.push("You use bullet points (" + bulletCount + "), which makes the resume easier to scan.");
    } else if (wordCount > 0) {
      issues.push("Add bullet points for responsibilities and achievements to improve readability.");
    }

    if (metricCount > 0) {
      strengths.push("You include numbers and metrics (" + metricCount + " occurrences).");
    } else if (wordCount > 0) {
      issues.push("Add concrete numbers (%, revenue, time saved) to show impact.");
    }

    if (avgSentence > 28) {
      issues.push("Sentences are quite long on average (" + avgSentence + " words). Consider shortening them.");
    } else if (avgSentence > 0) {
      strengths.push("Sentence length looks fine (about " + avgSentence + " words on average).");
    }

    var target = role || "your target role";

    steps.push(
      "Make sure the top of the resume clearly matches \"" + target + "\" (title, summary, main skills)."
    );
    steps.push(
      "Turn responsibilities into impact statements using metrics where possible (for example: \"reduced processing time by 20%\")."
    );
    steps.push(
      "Keep structure simple: 2–4 sections (Summary, Experience, Skills, Education) and consistent formatting."
    );

    var html = "";

    html +=
      "<div><p class='inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-[10px] text-slate-700 mb-2'>" +
      "AI-style review based on " +
      wordCount +
      " words" +
      "</p></div>";

    if (strengths.length) {
      html +=
        "<div><h4 class='text-[10px] font-semibold uppercase tracking-wide text-slate-600 mb-1'>Strengths</h4>";
      html += "<ul class='list-disc pl-4 text-[10px] space-y-0.5'>";
      strengths.forEach(function (s) {
        html += "<li>" + s + "</li>";
      });
      html += "</ul></div>";
    }

    if (issues.length) {
      html +=
        "<div><h4 class='text-[10px] font-semibold uppercase tracking-wide text-slate-600 mb-1'>Issues</h4>";
      html += "<ul class='list-disc pl-4 text-[10px] space-y-0.5'>";
      issues.forEach(function (s) {
        html += "<li>" + s + "</li>";
      });
      html += "</ul></div>";
    }

    html +=
      "<div><h4 class='text-[10px] font-semibold uppercase tracking-wide text-slate-600 mb-1'>Next steps</h4>";
    html += "<ul class='list-disc pl-4 text-[10px] space-y-0.5'>";
    steps.forEach(function (s) {
      html += "<li>" + s + "</li>";
    });
    html += "</ul></div>";

    return html;
  }

  aForm.addEventListener("submit", function (e) {
    e.preventDefault();

    var text = aTextArea.value || "";
    var role = document.getElementById("a-role").value.trim();

    if (!text.trim()) {
      aPreview.innerHTML =
        "<p class='text-[11px] text-slate-500'>Please upload a resume file (TXT recommended) or paste the resume text before running analysis.</p>";
      aPreviewEmpty.classList.add("hidden");
      aPreview.classList.remove("hidden");
      setStep(2);
      return;
    }

    aPreview.innerHTML = "<p class='text-[11px] text-slate-500'>Analyzing resume…</p>";
    aPreviewEmpty.classList.add("hidden");
    aPreview.classList.remove("hidden");

    // small timeout just to show "Analyzing…" state
    setTimeout(function () {
      var html = buildAnalysis(text, role);
      aPreview.innerHTML = html;
      setStep(3);
    }, 400);
  });

  aClear.addEventListener("click", function () {
    aForm.reset();
    aPreview.innerHTML = "";
    aPreview.classList.add("hidden");
    aPreviewEmpty.classList.remove("hidden");
    setStep(2);
  });
</script>

