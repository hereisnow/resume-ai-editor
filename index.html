<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Resume Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <style>
    html.app-loading {
      visibility: hidden;  /* –ù–∏—á–µ–≥–æ –Ω–µ –≤–∏–¥–Ω–æ, –Ω–µ—Ç ‚Äú—É–∑–∫–æ–≥–æ‚Äù —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    }
  </style>
  <script>
    // –ü–æ–º–µ—á–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ "–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"
    document.documentElement.classList.add('app-loading');
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—ë (CSS, JS, —à—Ä–∏—Ñ—Ç—ã) –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    window.addEventListener('load', function () {
      document.documentElement.classList.remove('app-loading');
    });
  </script>

  <!-- –¥–∞–ª—å—à–µ —Ç–≤–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π <style> —Å–æ –≤—Å–µ–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ -->
  ...
</head>

  <meta charset="UTF-8" />
  <title>AI Resume Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --panel: #ffffff;
      --panel-soft: #f9fafb;
      --border: #e5e7eb;
      --border-strong: #d1d5db;
      --text-main: #0f172a;
      --text-sub: #6b7280;
      --accent-blue: #2563eb;
      --accent-purple: #4f46e5;
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 1500px;           /* –®–ò–†–ï –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
      margin: 0 auto;
      padding: 24px 24px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .topbar {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 2px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-sub);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); /* –î–í–ê –®–ò–†–û–ö–ò–• –ë–õ–û–ö–ê */
      gap: 32px;
      margin-top: 24px;
      width: 100%;
    }

    @media (max-width: 1024px) {
      .app-shell { padding-inline: 16px; }
      .main-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
      padding: 24px 24px 20px;      /* —á—É—Ç—å –±–æ–ª—å—à–µ –ø–∞–¥–¥–∏–Ω–≥–∏ */
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-sub);
      padding-bottom: 6px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .card-tag-link {
      font-size: 11px;
      color: var(--accent-blue);
      cursor: pointer;
    }

    .card-body {
      background: #f5f7fb;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .dropzone {
      border-radius: var(--radius-lg);
      border: 2px dashed var(--border);
      background: var(--panel);
      padding: 32px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      cursor: pointer;
      transition: 0.15s ease;
      gap: 6px;
    }

    .dropzone.dragover {
      border-color: var(--accent-blue);
      background: #eff6ff;
    }

    .dropzone-title {
      font-size: 14px;
      font-weight: 600;
    }

    .dropzone-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .textarea {
  width: 100%;
  height: 340px;              /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–æ–ª—å—à–∞—è –≤—ã—Å–æ—Ç–∞ */
  resize: none;               /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç –±–ª–æ–∫ */
  overflow-y: auto;           /* –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏ */
  padding: 10px 12px;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  font-size: 13px;
  background: var(--panel);
  outline: none;
  line-height: 1.45;
}

    .textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.22);
      background: #ffffff;
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
    }

    .prompt-input-row {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .prompt-input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 9999px;
      border: 1px solid var(--border);
      font-size: 13px;
      background: var(--panel);
      outline: none;
    }

    .prompt-input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.22);
      background: #ffffff;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: #e5e7eb;
      color: #374151;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .chip:hover {
      background: #d1d5db;
    }

    .advanced {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border);
      padding: 8px 10px;
      background: #f9fafb;
    }

    .advanced-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-sub);
      cursor: pointer;
    }

    .advanced-title { font-weight: 600; }

    .advanced-body {
      margin-top: 8px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 8px;
    }

    @media (max-width: 640px) {
      .advanced-body { grid-template-columns: minmax(0, 1fr); }
    }

    .advanced-body.hidden { display: none; }

    .advanced-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .advanced-control {
      width: 100%;
      padding: 6px 10px;
      border-radius: 9999px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: #ffffff;
      outline: none;
    }

    .advanced-control:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.20);
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    .btn {
      border-radius: 9999px;
      border: none;
      padding: 10px 22px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-analyze { background: var(--accent-purple); }
    .btn-generate { background: var(--accent-blue); }

    .btn:disabled {
      opacity: 0.7;
      cursor: default;
    }
.result-inner {
  background: var(--panel-soft);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  height: 340px;             /* —Ç–∞–∫–∞—è –∂–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –∫–∞–∫ —Å–ª–µ–≤–∞ */
  padding: 16px 14px;
  font-size: 13px;
  color: var(--text-sub);
  white-space: pre-wrap;
  overflow-y: auto;          /* –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –±–µ–∑ —Ä–æ—Å—Ç–∞ –±–ª–æ–∫–∞ */
}


    .right-header-extra {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 14px;
    }

    .icon-btn {
      width: 26px;
      height: 26px;
      border-radius: 9999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="title">AI Resume Editor</div>
      <div class="subtitle">
        Based on real needs of Reddit users ¬∑ Drag &amp; drop your existing resume and improve it with AI.
      </div>
    </header>

    <main class="main-grid">
      <!-- LEFT: SOURCE RESUME -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">Source Resume</span>
          <span class="card-tag-link">ATS Scan View</span>
        </div>
        <div class="card-body">
          <div id="dropzone" class="dropzone">
            <div class="dropzone-title">Drag &amp; Drop PDF, DOCX, TXT</div>
            <div class="dropzone-sub">Max: PDF 5MB, DOCX 3MB ¬∑ or click to browse</div>
          </div>
          <input id="fileInput" type="file" accept=".pdf,.doc,.docx,.txt" style="display:none" />

          <textarea id="sourceText" class="textarea" placeholder="Extracted resume text will appear here... You can also paste text directly."></textarea>
          <div class="hint">Make sure the text looks clean before sending it to AI.</div>

          <div class="prompt-input-row">
            <input id="prompt" class="prompt-input" type="text"
                   placeholder="E.g., Rewrite for a Senior Developer role, focusing on leadership..." />
            <div class="chips-row">
              <button type="button" class="chip" id="chipGrammar">Fix Grammar</button>
              <button type="button" class="chip" id="chipTone">Professional Tone</button>
              <button type="button" class="chip" id="chipMetrics">Add Metrics</button>
            </div>
          </div>

          <div class="advanced" id="advancedBox">
            <div class="advanced-header" id="advancedToggle">
              <span class="advanced-title">Advanced settings</span>
              <span id="advancedToggleLabel">Show</span>
            </div>
            <div class="advanced-body hidden" id="advancedBody">
              <div>
                <div class="advanced-label">Target language</div>
                <select id="advLanguage" class="advanced-control">
                  <option value="en" selected>English</option>
                  <option value="ru">Russian</option>
                </select>
              </div>
              <div>
                <div class="advanced-label">Career level</div>
                <select id="advLevel" class="advanced-control">
                  <option value="student">Student / Entry</option>
                  <option value="mid">Mid-level</option>
                  <option value="senior" selected>Senior</option>
                </select>
              </div>
              <div>
                <div class="advanced-label">Target role (optional)</div>
                <input id="advRole" class="advanced-control" type="text"
                       placeholder="e.g. Frontend Developer" />
              </div>
              <div>
                <div class="advanced-label">Tone</div>
                <select id="advTone" class="advanced-control">
                  <option value="neutral" selected>Neutral professional</option>
                  <option value="formal">Formal</option>
                  <option value="concise">Extra concise</option>
                </select>
              </div>
            </div>
          </div>

          <div class="actions-row">
            <button id="analyzeBtn" class="btn btn-analyze" type="button">üîç Analyze</button>
            <button id="generateBtn" class="btn btn-generate" type="button">‚ú® Generate</button>
          </div>
        </div>
      </section>

      <!-- RIGHT: AI RESULT -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">AI Result</span>
          <div class="right-header-extra">
            <button type="button" class="icon-btn" id="btnCopy" title="Copy to clipboard">üìã</button>
            <button type="button" class="icon-btn" id="btnDownload" title="Download TXT">üìÑ</button>
            <button type="button" class="icon-btn" id="btnEditToSource" title="Send back to source">‚úèÔ∏è</button>
          </div>
        </div>
        <div class="result-inner" id="aiOutput">AI generated content will appear here...</div>
      </section>
    </main>
  </div>

  <!-- DOCX extractor -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- MAIN SCRIPT -->
  <script type="module">
    import * as pdfjsLib from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.mjs";

    // URL —Ç–≤–æ–µ–≥–æ backend –Ω–∞ Render (Gemini-–≤–µ—Ä—Å–∏—è)
    const BACKEND_URL = "https://resume-ai-editor-backend.onrender.com";

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const sourceText = document.getElementById('sourceText');
    const promptInput = document.getElementById('prompt');
    const aiOutput = document.getElementById('aiOutput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const generateBtn = document.getElementById('generateBtn');

    const advancedBody = document.getElementById('advancedBody');
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedToggleLabel = document.getElementById('advancedToggleLabel');
    const advLanguage = document.getElementById('advLanguage');
    const advLevel = document.getElementById('advLevel');
    const advRole = document.getElementById('advRole');
    const advTone = document.getElementById('advTone');

    const chipGrammar = document.getElementById('chipGrammar');
    const chipTone = document.getElementById('chipTone');
    const chipMetrics = document.getElementById('chipMetrics');

    const btnCopy = document.getElementById('btnCopy');
    const btnDownload = document.getElementById('btnDownload');
    const btnEditToSource = document.getElementById('btnEditToSource');

    const MASTER_PROMPT = `–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π –º–æ—ë —Ä–µ–∑—é–º–µ –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –¢–ó.
–ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ, –∏–∑–±–µ–≥–∞–π –≤–æ–¥—ã. –ù–∞—á–∏–Ω–∞–π –±—É–ª–ª–µ—Ç—ã —Å —Å–∏–ª—å–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è.
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö, —Ü–∏—Ñ—Ä–∞—Ö –∏ –ø–æ–Ω—è—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (Summary, Skills, Experience, Education).`;

    // ----- Advanced UI -----
    advancedToggle.addEventListener('click', () => {
      const hidden = advancedBody.classList.toggle('hidden');
      advancedToggleLabel.textContent = hidden ? 'Show' : 'Hide';
    });

    function appendPrompt(text) {
      const current = promptInput.value.trim();
      promptInput.value = current ? current + ' ¬∑ ' + text : text;
      promptInput.focus();
    }

    chipGrammar.addEventListener('click', () => appendPrompt('Fix grammar and clarity.'));
    chipTone.addEventListener('click', () => appendPrompt('Use a confident, professional tone.'));
    chipMetrics.addEventListener('click', () => appendPrompt('Add concrete metrics and impact (%, $, time saved).'));

    // ----- Drag & Drop -----
    ['dragenter','dragover'].forEach(evt => {
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(evt => {
      dropzone.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('drop', e => {
      const file = e.dataTransfer.files?.[0];
      if (file) handleFile(file);
    });

    fileInput.addEventListener('change', e => {
      const file = e.target.files?.[0];
      if (file) handleFile(file);
    });

    function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'txt') {
        const reader = new FileReader();
        reader.onload = e => { sourceText.value = e.target.result; };
        reader.readAsText(file);
      } else if (ext === 'pdf') {
        extractPdf(file);
      } else if (ext === 'docx' || ext === 'doc') {
        extractDocx(file);
      } else {
        alert('Unsupported file type. Please upload PDF, DOCX, or TXT.');
      }
    }

    async function extractPdf(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(it => it.str);
          text += strings.join(' ') + "\n";
        }
        sourceText.value = text.trim();
      } catch (err) {
        console.error(err);
        alert('Error extracting text from PDF. You can convert it to TXT and upload again.');
      }
    }

    function extractDocx(file) {
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const arrayBuffer = e.target.result;
          const result = await window.mammoth.extractRawText({ arrayBuffer });
          sourceText.value = result.value.trim();
        } catch (err) {
          console.error(err);
          alert('Error extracting text from DOCX. You can convert it to TXT and upload again.');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function buildAdvancedInstructions() {
      const parts = [];
      const lang = advLanguage.value;
      const level = advLevel.value;
      const role = advRole.value.trim();
      const tone = advTone.value;

      if (lang === 'en') parts.push('Write the resume in English.');
      if (lang === 'ru') parts.push('Write the resume in Russian.');

      if (level === 'student') parts.push('Position the candidate as a student or entry-level specialist.');
      else if (level === 'mid') parts.push('Position the candidate as a mid-level professional.');
      else if (level === 'senior') parts.push('Position the candidate as a senior-level professional with leadership responsibilities.');

      if (role) parts.push(`Optimize the resume for the target role: "${role}" and include relevant keywords.`);

      if (tone === 'formal') parts.push('Use a formal corporate tone.');
      else if (tone === 'concise') parts.push('Make the writing extra concise and remove everything that does not add clear value.');
      else if (tone === 'neutral') parts.push('Use a neutral, modern professional tone.');

      return parts.join(' ');
    }

    async function callAI(mode) {
      const resume = sourceText.value.trim();
      const userPrompt = promptInput.value.trim();
      const extra = buildAdvancedInstructions();

      const basePrompt =
        mode === "analyze"
          ? "–°–Ω–∞—á–∞–ª–∞ –∫–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —ç—Ç–æ–≥–æ —Ä–µ–∑—é–º–µ, –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é."
          : MASTER_PROMPT;

      const prompt =
        (userPrompt || basePrompt) +
        (extra ? `\n\nAdditional requirements:\n${extra}` : "");

      if (!resume) {
        alert("Please paste or upload your resume text first.");
        return;
      }

      const activeBtn = mode === "analyze" ? analyzeBtn : generateBtn;
      activeBtn.disabled = true;
      activeBtn.textContent = mode === "analyze" ? "Analyzing..." : "Generating...";

      aiOutput.textContent =
        mode === "analyze"
          ? "AI is analyzing your resume..."
          : "AI is rewriting your resume...";

      try {
        const response = await fetch(`${BACKEND_URL}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ resume, prompt })
        });

        if (!response.ok) {
          const errText = await response.text();
          aiOutput.textContent = "Backend returned an error:\n\n" + errText;
          return;
        }

        const data = await response.json();
        aiOutput.textContent = data.text || "No text field in backend response.";
      } catch (err) {
        console.error("callAI exception:", err);
        aiOutput.textContent = "Network or CORS error. Try again later.";
      } finally {
        activeBtn.disabled = false;
        activeBtn.textContent = mode === "analyze" ? "üîç Analyze" : "‚ú® Generate";
      }
    }

    analyzeBtn.addEventListener('click', () => callAI('analyze'));
    generateBtn.addEventListener('click', () => callAI('generate'));

    // Result actions
    btnCopy.addEventListener('click', async () => {
      const text = aiOutput.textContent || '';
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        alert('Copied to clipboard.');
      } catch (_) {
        alert('Could not copy. Select and copy manually.');
      }
    });

    btnDownload.addEventListener('click', () => {
      const text = aiOutput.textContent || '';
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ai-resume.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnEditToSource.addEventListener('click', () => {
      const text = aiOutput.textContent || '';
      if (!text) return;
      sourceText.value = text;
      sourceText.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</body>
</html>
